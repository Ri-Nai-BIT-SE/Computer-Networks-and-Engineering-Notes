# 1.7.3 具有五层协议的体系结构

## 五层协议体系结构

### 应用层（Application Layer）
- **任务**：通过应用进程间的交互来完成特定网络应用
- **协议**：HTTP、SMTP、FTP、DNS等
- **数据单元**：报文（Message）

### 运输层（Transport Layer）
- **任务**：负责向两台主机中进程之间的通信提供通用的数据传输服务
- **协议**：TCP、UDP
- **数据单元**：报文段（Segment）或用户数据报（User Datagram）

### 网络层（Network Layer）
- **任务**：负责为分组交换网上的不同主机提供通信服务
- **协议**：IP、ICMP、ARP等
- **数据单元**：IP数据报（Datagram）或分组（Packet）

### 数据链路层（Data Link Layer）
- **任务**：在两个相邻节点之间传送数据帧
- **协议**：PPP、以太网协议等
- **数据单元**：帧（Frame）

### 物理层（Physical Layer）
- **任务**：在物理媒体上传输原始比特流
- **协议**：各种物理层协议
- **数据单元**：比特（Bit）

## 各层之间的关系
- 下层为上层提供服务
- 数据封装：从上层到下层，每层添加首部（或尾部）
- 数据解封装：从下层到上层，每层去掉首部（或尾部）

## 数据封装与解封装（重点中的重点）

### 封装过程（发送端）
数据从应用层向下传递时，每一层都会添加自己的**首部（Header）**：
1. **应用层**：生成报文（Message）
2. **运输层**：添加TCP/UDP首部 → 报文段（Segment）
3. **网络层**：添加IP首部 → IP数据报（Datagram/Packet）
4. **数据链路层**：添加帧首部和帧尾部 → 帧（Frame）
5. **物理层**：转换为比特流（Bit）在物理媒体上传输

### 解封装过程（接收端）
数据从物理层向上传递时，每一层都会去掉自己的首部：
1. **物理层**：接收比特流
2. **数据链路层**：去掉帧首尾，提取数据报
3. **网络层**：去掉IP首部，提取报文段
4. **运输层**：去掉TCP/UDP首部，提取报文
5. **应用层**：获得原始数据

### ⚠️ 路由器的工作过程（考试重点）

**关键场景**：主机 A 发送数据给主机 B，中间经过路由器 R

#### 路由器的工作特点
1. **路由器工作在网络层（第3层）**
   - 路由器**最高只到网络层**，不处理运输层和应用层
   - 路由器会**解封装**到网络层，查看IP首部，查找路由表

2. **数据在路由器中的处理过程**：
   ```
   主机A → 路由器R → 主机B
   
   在路由器R中：
   ① 接收：从物理层接收比特流
   ② 解封装：去掉数据链路层首部（帧首尾）
   ③ 查看IP首部：提取目的IP地址
   ④ 查路由表：根据目的IP地址查找下一跳
   ⑤ 重新封装：添加新的数据链路层首部（新的MAC地址）
   ⑥ 发送：通过物理层发送出去
   ```

3. **关键变化**：
   - **IP地址**：在传输过程中**通常不变**（源IP和目的IP保持不变）
   - **MAC地址**：在**每一跳都会变化**
     - 从主机A到路由器R：源MAC是A的，目的MAC是R的
     - 从路由器R到主机B：源MAC是R的，目的MAC是B的

### 地址的三重身份（结合Wireshark实验）

在同一个数据包中，有三个不同层次的地址：

1. **MAC地址（物理地址）**
   - **层次**：数据链路层使用
   - **作用**：负责**相邻跳**（下一站去哪）
   - **特点**：在**每一跳都会变化**
   - **范围**：局域网内，相邻节点之间

2. **IP地址（逻辑地址）**
   - **层次**：网络层使用
   - **作用**：负责**起点到终点**（端到端）
   - **特点**：传输过程中**通常不变**（NAT除外，但理论分析默认不变）
   - **范围**：整个互联网，全局唯一

3. **端口号**
   - **层次**：运输层使用
   - **作用**：找到具体的**应用程序**（如Web服务是80端口）
   - **特点**：标识进程，在端到端通信中保持不变

### 典型考题
**题目1**：当数据经过路由器时，IP地址变不变？MAC地址变不变？

**答案**：
- **IP地址不变**：IP地址标识的是起点和终点，在整个传输过程中保持不变
- **MAC地址会变**：MAC地址标识的是相邻节点，在每一跳都会变化（源MAC变成路由器的，目的MAC变成下一跳的）

**题目2**：路由器解封装到哪一层？

**答案**：路由器解封装到**网络层（第3层）**，查看IP首部后重新封装数据链路层和物理层，不处理运输层和应用层。

