# 4.4.3 ICMP 的应用举例 ⭐⭐⭐ **高频考点**

## 1. PING (Packet InterNet Groper)

### 基本概念

- **作用**：测试两个主机之间的**连通性**。
- **原理**：使用了 ICMP **回送请求 (Echo Request, Type=8)** 和 **回送回答 (Echo Reply, Type=0)** 报文。
- **特点**：是应用层直接使用网络层 ICMP 的例子，**没有通过运输层的 TCP 或 UDP**。

### 实例分析

**命令**：`ping mail.sina.com.cn`

**输出示例**：
```text
Reply from 202.108.43.230: bytes=32 time=368ms TTL=242
```

**输出分析**：
- **bytes=32**：发送的数据长度（32字节）
- **time=368ms**：往返时间（RTT, Round-Trip Time），用于评估网络延迟
- **TTL=242**：这是**对方**发送回来的报文中的生存时间
  - 对方初始TTL可能是255，经过13跳后变成242（255-13=242）

### 工作过程

1. 源主机直接使用**网络层**的 ICMP 协议（**没有通过运输层的TCP或UDP**）
2. 发送 **ICMP 回送请求 (Type=8)** 报文
3. 目的主机收到后，剥去 IP 首部，发现是 ICMP 回送请求，立即构建 **ICMP 回送回答 (Type=0)** 报文发回
4. 源主机收到回送回答，显示连通性测试成功

**工作流程图：**

<ICMPDiagram />

## 2. Traceroute (Windows下为 tracert)

### 基本概念

- **作用**：跟踪一个分组从源点到终点的**路径**。
- **原理**：利用 **TTL** 字段，通过逐步增加 TTL 值来探测路径上的每一跳路由器。

### 实例分析

**命令**：`tracert mail.sina.com.cn`

**输出示例**：
```text
1    24 ms    24 ms    23 ms    222.95.172.1
2    23 ms    24 ms    22 ms    221.231.204.129
...
12   321 ms   322 ms   320 ms   202.108.43.230
```

**输出分析**：
- **序号 (1, 2...)**：代表这是第几个路由器（第几跳）
- **时间 (如 24ms)**：发送了 3 次探测，所以有 3 个时间数据，表示往返时延
- **IP 地址**：该跳路由器的 IP 地址

### 工作原理详解

#### 第一跳

1. 源主机发送一个 IP 数据报，**TTL 设置为 1**
2. 数据报到达第 1 个路由器（222.95.172.1）
3. 路由器将 TTL 减 1 变为 0，丢弃包
4. 路由器向源主机发送 **ICMP 时间超过 (Time Exceeded, Type=11)** 差错报文
5. 源主机收到报文，解析出发送者的 IP 是 222.95.172.1，从而得到第一跳地址

#### 第二跳

1. 源主机发送数据报，**TTL 设置为 2**
2. 通过第 1 个路由器（TTL变1），到达第 2 个路由器
3. 第 2 个路由器将 TTL 减 1 变为 0，丢弃包
4. 发送 **ICMP 时间超过** 报文
5. 源主机得到第 2 个路由器的 IP（221.231.204.129）

#### 到达终点

1. 源主机不断增加 TTL，直到数据报到达目的主机（202.108.43.230）
2. 数据报封装的是一个**无法交付的 UDP 端口**（或 Echo Request）
3. 目的主机收到后，发现端口不可达，发送 **ICMP 终点不可达 (Destination Unreachable, Type=3)** 差错报文
4. 源主机收到此特定报文，知道已到达终点，停止探测

### 关键要点总结

只要考到 Traceroute/tracert，关键词就是：
- **TTL**：逐步增加TTL值（1, 2, 3...）
- **ICMP 时间超过 (Type=11)**：中间路由器TTL=0时发送
- **ICMP 终点不可达 (Type=3)**：到达终点时发送

## 本节复习核心总结 (必背)

1. **ICMP 并不独立**，它装在 IP 数据报里传（协议号 1）
2. **差错报文数据字段** = IP首部 + 前8字节（包含端口号）
3. **PING** = ICMP 回送请求/回答（应用层直接用网络层，不经过传输层）
4. **Traceroute** = 利用 TTL 过期触发 ICMP 时间超过 + 终点触发 ICMP 终点不可达

