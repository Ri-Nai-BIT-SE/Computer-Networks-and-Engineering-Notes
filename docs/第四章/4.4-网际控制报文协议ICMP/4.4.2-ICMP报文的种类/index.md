# 4.4.2 ICMP 报文的种类 ⭐ **考点**

主要分为 **差错报告报文** 和 **询问报文** 两种。

## (1) 差错报告报文 (Error Reporting)

当路由器或主机在处理 IP 数据报时遇到问题，会向**源主机**发送此类报文。

### 常见类型

1. **终点不可达 (Destination Unreachable)**：路由器或主机无法交付数据报（类型值 3）。
2. **时间超过 (Time Exceeded)**：
   - 路由器收到 TTL=0 的数据报（丢弃并报错）。
   - 终点在预定时间内未收到所有分片（丢弃并报错）。
   - *注：这是 Traceroute 的核心原理。*
3. **参数问题 (Parameter Problem)**：首部字段有问题。
4. **改变路由 (Redirect)**：路由器告诉主机，下次发给另一个路由器（更好的路由）。

### 数据字段结构 ⭐⭐ **重点考点**

差错报告报文的数据部分包含：

1. **收到的 IP 数据报的首部**（包含源IP、目的IP等关键信息）
2. **收到的 IP 数据报数据字段的前 8 个字节**

**为什么是前8个字节？**

- 这包含了运输层（TCP/UDP）的**源端口和目的端口**
- 源主机收到报错后，就能知道是哪个进程（端口）发送的数据出问题了
- TCP/UDP首部的前8字节正好包含源端口（2字节）+ 目的端口（2字节）+ 其他字段（4字节）

**结构图示：**

```
ICMP差错报文 = [ICMP首部(类型/代码/检验和)] + [原IP首部] + [原IP数据的前8字节]
```

### 不发送差错报文的情况

- 对 ICMP 差错报文本身不再报错。
- 对分片数据报，只对第一个分片报错。
- 对多播地址、特殊地址（如127.0.0.0, 0.0.0.0）不报错。

## (2) 询问报文 (Query)

- **回送请求和回答 (Echo Request / Reply)**：主机或路由器向特定目的主机发出询问，收到者必须回送回答。用于测试连通性（类型值 8 和 0）。
- **时间戳请求和回答**：用于时钟同步和时间测量。


