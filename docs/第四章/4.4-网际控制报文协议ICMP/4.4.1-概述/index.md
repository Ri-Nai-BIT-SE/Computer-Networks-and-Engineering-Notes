# 4.4.1 概述

- **作用**：为了更有效地转发 IP 数据报和提高交付成功的机会，允许主机或路由器报告**差错情况**和提供有关**异常情况**的报告。
- **地位**：ICMP 是互联网的标准协议，属于**网络层协议**。
- **封装**：ICMP 报文装在 **IP 数据报** 中作为数据部分传输（协议字段值 = 1）。

**重要**：ICMP 并不独立，它装在 IP 数据报里传输。

## ICMP 报文的结构详解 ⭐ **考点**

虽然 ICMP 报文类型众多，但它们的前 4 个字节是统一的。

### 通用格式

| 字段名称 | 长度 | 说明 |
| :--- | :--- | :--- |
| **类型 (Type)** | 8位 (1字节) | 指明 ICMP 报文的种类（如：回送请求是8，回送回答是0，超时是11，终点不可达是3）。 |
| **代码 (Code)** | 8位 (1字节) | 为了进一步区分某种类型中的不同情况（例如在"终点不可达"类型中，代码可以区分是"网络不可达"还是"端口不可达"）。 |
| **检验和 (Checksum)** | 16位 (2字节) | 检验整个 ICMP 报文（包括首部和数据部分）。 |
| **数据部分** | 可变 | 长度取决于 ICMP 报文的类型。 |

### 差错报告报文的数据字段结构 ⭐⭐ **重点考点**

当网络出现错误（如TTL耗尽、终点不可达）时，路由器发送的 ICMP 差错报文的数据部分必须包含以下内容，以便源主机知道是哪条数据出错了：

**结构组成：**

1. **收到的 IP 数据报的首部**（包含源IP、目的IP等关键信息）
2. **收到的 IP 数据报数据字段的前 8 个字节**
   - *为什么是前8个字节？* 因为这包含了运输层（TCP/UDP）的**源端口和目的端口**。这样源主机收到报错后，就能知道是哪个进程（端口）发送的数据出问题了。

**图示理解：**

<ICMPDiagram />

**示例**：
- 如果源主机发送了一个UDP数据报到端口53（DNS），但目的主机端口不可达
- ICMP差错报文会包含原IP首部（源IP、目的IP）和原UDP首部（源端口、目的端口）
- 源主机收到后就能知道是哪个应用（端口）的数据出错了

