# 4.8.2 网络地址转换 NAT (Network Address Translation)

## 1. 作用

解决专用网内部的主机（使用专用地址）如何与互联网上的主机通信的问题，同时缓解 IPv4 地址耗尽。

## 2. NAT 的工作原理

需要在连接专用网和互联网的路由器上安装 NAT 软件（NAT路由器）。

- **离开专用网时（出）**：将源 IP 地址（本地地址）替换为 **全球 IP 地址**（NAT 路由器的 WAN 口地址）。
- **进入专用网时（入）**：将目的 IP 地址（全球地址）替换为 **本地地址**。

## 3. 网络地址与端口号转换 NAPT (Network Address and Port Translation)

- **传统 NAT 的局限**：如果只有一个全球 IP，同一时间只能有一个内网主机上网。
- **NAPT (也常被称为 PAT)**：使用 **运输层端口号** 来区分不同的内网主机。
  - 允许多个拥有本地地址的主机，**共用一个**全球 IP 地址上网。

### NAPT 转换表 (NAT Table) 示例

| 方向 | 转换前 (IP : 端口) | 转换后 (IP : 端口) | 说明 |
| :--- | :--- | :--- | :--- |
| **出 (Out)** | `192.168.0.3 : 30000` | `172.38.1.5 : 40001` | 将内网主机的源IP/端口替换为路由器的公网IP/新端口 |
| **出 (Out)** | `192.168.0.4 : 30000` | `172.38.1.5 : 40002` | 即使内网端口相同，路由器也会分配不同的外网端口以示区分 |
| **入 (In)** | `172.38.1.5 : 40001` | `192.168.0.3 : 30000` | 收到回包时，根据目的端口 40001 查表，转发给内网主机 A |

### 特点

- 对外网隐藏了内部网络的结构。
- 内网主机可以访问外网服务器，但外网主机通常无法主动发起对内网主机的访问（除非配置端口映射）。



