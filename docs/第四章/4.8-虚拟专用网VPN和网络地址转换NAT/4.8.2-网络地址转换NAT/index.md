# 4.8.2 网络地址转换 NAT (Network Address Translation)

## 1. 概念与作用

*   **定义**：在专用网连接到互联网的路由器上安装 NAT 软件，使专用网内部的主机可以通过该路由器访问互联网。
*   **作用**：**缓解 IPv4 地址耗尽问题**。它允许多台内部主机共享少量的全球 IP 地址访问互联网。
*   **NAT 路由器**：至少需要有一个有效的外部全球 IP 地址。

## 2. 工作原理

NAT 路由器维护一张 **NAT 转换表**。

*   **出网过程（内部 $\to$ 外部）**：
    1.  内部主机发送数据报（源 IP：`192.168.x.x`）。
    2.  NAT 路由器接收后，将**源 IP 地址**替换为路由器的**全球 IP 地址**。
    3.  在 NAT 转换表中记录映射关系，转发到互联网。

*   **入网过程（外部 $\to$ 内部）**：
    1.  互联网服务器返回响应数据报（目的 IP：NAT 路由器的全球 IP）。
    2.  NAT 路由器查询转换表，将**目的 IP 地址**替换回内部主机的**专用 IP 地址**。
    3.  转发给内部主机。

## 3. 网络地址与端口号转换 NAPT (Network Address and Port Translation)

普通的 NAT 是一对一转换，若多个内网主机同时上网，需要多个公网 IP。为了让**多个内网主机共用一个公网 IP**，引入了 NAPT（也常被称为 PAT）。

*   **原理**：利用传输层的**端口号**来区分不同的内部主机。
*   **NAPT 转换表**：
    *   记录 `{本地 IP : 本地端口}` 到 `{全球 IP : 全球端口}` 的映射。
    *   不同内部主机发出的数据报，在通过 NAT 路由器时，会被分配不同的**临时全球端口号**。
*   **优势**：一个全球 IP 地址就可以支持很多台主机同时访问互联网。

## 4. 优缺点

*   **优点**：节省公网 IP；隐藏了内部网络结构，增加安全性。
*   **缺点**：
    *   通信必须由内部发起（外网无法主动访问内网主机，除非配置端口映射）。
    *   违反了网络的分层结构（路由器修改了网络层甚至传输层的头部）。
    *   增加了路由器的处理开销，可能增大时延。

---

### ⚠️ 考点提示

1.  **专用地址范围**：选择题常考，要能识别出哪些是私网 IP（如 `192.168.1.1`）。
2.  **NAT 转换表**：可能会出大题，让你填表。
    *   **关键点**：出网时改**源** IP/端口；入网时改**目的** IP/端口。
3.  **VPN 原理**：理解隧道技术是"包里套包"，外层 IP 是公网地址，内层 IP 是私网地址。
