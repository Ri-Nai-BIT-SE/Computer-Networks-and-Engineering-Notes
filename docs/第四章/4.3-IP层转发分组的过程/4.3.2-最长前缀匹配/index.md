# 4.3.2 最长前缀匹配 (Longest Prefix Matching) ⭐⭐⭐ **高频考点**

## 背景

使用 **CIDR (无分类编址)** 后，路由表中的项目使用"网络前缀"来表示。

**问题**：一个目的IP地址可能会同时匹配转发表中的多个表项。

例如，目的IP `128.1.2.196` 可能既匹配：
- 一个 `/20` 的地址块（如 `128.1.2.0/20`）
- 一个 `/24` 的地址块（如 `128.1.2.0/24`）

## 原则

**规则**：应当从匹配结果中选择**网络前缀最长**的那个作为匹配项。

**原理**：
- 网络前缀越长 → 主机号越短 → 地址块越小 → 路由越具体 (More Specific)
- 更具体的路由应该优先匹配

**实现技巧**：在转发表中，通常将前缀最长的项排在前面，以便优先匹配。

## 实例分析

假设转发表中有以下两项：

- **路由1**：`128.1.2.192/26` (掩码: `255.255.255.192`) → 下一跳 R2
- **路由2**：`128.1.2.128/25` (掩码: `255.255.255.128`) → 接口1 (直连)

**场景**：路由器收到目的IP为 `128.1.2.196` 的分组。

### 检查路由1

```
128.1.2.196 AND 255.255.255.192 = 128.1.2.192
```

结果与路由1的前缀 `128.1.2.192` 一致 → **匹配**

### 检查路由2

```
128.1.2.196 AND 255.255.255.128 = 128.1.2.128
```

结果与路由2的前缀 `128.1.2.128` 一致 → **也匹配**

### 结论

- 路由1的前缀长度是 **26位**
- 路由2的前缀长度是 **25位**
- 根据**最长前缀匹配**原则，选择路由1
- 分组转发给 **R2**

## 两种特殊的路由

### 1. 主机路由 (Host Route)

- **格式**：`a.b.c.d/32`
- **特点**：掩码是32位（`255.255.255.255`），意味着必须每一位都完全匹配
- **优先级**：最高（因为前缀最长，32位）
- **用途**：通常用于特定网络管理或安全需求

### 2. 默认路由 (Default Route)

- **格式**：`0.0.0.0/0`
- **特点**：掩码是0位。任何IP地址与0进行AND运算都是0，所以能匹配所有地址
- **优先级**：最低（兜底策略）
- **场景**：当分组在转发表中找不到任何其他匹配项时，走默认路由（通常指向连接互联网的出口路由器）

## 匹配过程 ⚠️ **易错点**

**重要**：必须用目的IP和路由表中的**子网掩码 (Mask)** 做 **AND 运算**，结果和**网络地址**比较，相等才叫匹配。

**步骤**：
1. 目的IP地址 AND 子网掩码 = 网络地址
2. 比较计算出的网络地址与转发表中的网络地址
3. 如果相等，则匹配
4. 如果多个匹配，选择前缀最长的

