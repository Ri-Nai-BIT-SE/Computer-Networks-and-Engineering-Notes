# 4.3.3 路由器分组转发算法 ⭐ **核心算法**

## 完整流程

当路由器收到一个目的IP地址为 `D` 的数据报时，按以下步骤处理：

### 1. 提取目的IP地址

从收到的分组首部提取**目的IP地址 (D)**。

### 2. 检查特定主机路由

先检查是否有 `D` 的特定主机路由 (`/32`)。

- 若有，按该路由转发
- 若没有，继续下一步

**注意**：特定主机路由优先级最高（前缀最长，32位）。

### 3. 最长前缀匹配

逐行检查转发表，对所有匹配的行，选择**前缀最长**的一行进行转发。

**匹配过程**：
- 对转发表中的每一行，用其**掩码**与 `D` 做 **AND 运算**
- 看结果是否等于该行的**目的网络地址**
- 若匹配多行，选择**前缀最长**的一行

**示例**：
```
目的IP: 128.1.2.196
路由1: 128.1.2.192/26 (匹配，前缀长度26)
路由2: 128.1.2.128/25 (匹配，前缀长度25)
→ 选择路由1（前缀更长）
```

### 4. 检查默认路由

若以上都没找到匹配项，检查是否有默认路由 (`0.0.0.0/0`)。

- 若有，转发给默认路由器
- 若没有，继续下一步

**注意**：默认路由优先级最低（前缀最短，0位），是最后匹配的。

### 5. 丢弃分组

若默认路由也没有，则：
- 报告转发分组出错
- 丢弃该分组
- 发送 ICMP 差错报文（目的不可达）

## 算法流程图

```
收到分组
  ↓
提取目的IP地址 D
  ↓
检查特定主机路由 (/32)
  ├─ 匹配 → 转发
  └─ 不匹配 ↓
检查网络路由（最长前缀匹配）
  ├─ 匹配 → 选择前缀最长的 → 转发
  └─ 不匹配 ↓
检查默认路由 (0.0.0.0/0)
  ├─ 存在 → 转发
  └─ 不存在 ↓
丢弃分组，发送ICMP错误
```

## 关键要点

1. **匹配顺序**：特定主机路由 → 网络路由（最长前缀） → 默认路由
2. **匹配方法**：目的IP AND 掩码 = 网络地址，然后比较
3. **选择原则**：多个匹配时，选择前缀最长的
4. **默认路由位置**：在查找逻辑中，默认路由是最后匹配的（因为它前缀最短，为0）

