# 4.3.1 基于终点的转发 (Destination-Based Forwarding)

## 基本概念

### 逐跳转发 (Hop-by-hop)

- 分组在互联网中是经由一个个路由器**逐跳转发**的。
- 路由器不需要知道到达终点的完整路径，只需要知道**下一跳**该发给谁。

### 转发依据

- 路由器**仅根据分组首部中的目的IP地址**进行转发。
- **不考虑源IP地址**，只关注目的地址。

## 转发表 (Forwarding Table) 的结构

### 为什么使用网络地址而不是主机地址？

- 为了**压缩转发表的大小**，转发表不是列出每一个"目的主机IP"，而是列出**目的网络地址**。
- **原因**：连接在同一个局域网上的所有主机，其**网络前缀（Network Prefix）是相同的**。

### 转发表的主要列

转发表通常包含以下信息：

1. **目的网络地址 (Destination Network)**
   - 也就是网络前缀（Network Prefix）
   - 例如：`192.168.1.0/24`

2. **子网掩码 (Subnet Mask)**
   - 用于确定网络前缀的长度
   - 例如：`255.255.255.0` 对应 `/24`

3. **下一跳地址 (Next Hop)**
   - **直接交付 (Direct Delivery)**：下一跳是路由器自身的**接口编号**（如 `eth0`、`接口1`）
   - **间接交付 (Indirect Delivery)**：下一跳是**下一个路由器的接口IP地址**

### 转发表示例

假设路由器 R1 的网络拓扑如下：
- R1 的接口1（IP: `192.168.1.1`）连接到网络 `192.168.1.0/24`
- R1 的接口2（IP: `10.0.1.1`）连接到路由器 R2 的接口（IP: `10.0.1.2`）
- R1 的接口3（IP: `172.16.1.1`）连接到路由器 R3 的接口（IP: `172.16.1.2`）

R1 的转发表可能如下：

| 目的网络地址 | 子网掩码 | 下一跳 |
|------------|---------|--------|
| 192.168.1.0 | 255.255.255.0 | 接口1 |
| 10.0.0.0 | 255.0.0.0 | 10.0.1.2 |
| 172.16.0.0 | 255.255.0.0 | 172.16.1.2 |
| 0.0.0.0 | 0.0.0.0 | 10.0.1.2 |

**说明**：
- 第一行：`192.168.1.0/24` 是直接相连的网络，下一跳填写**接口1**（直接交付）
- 第二行：`10.0.0.0/8` 需要通过 R2 转发，下一跳填写 R2 的直连接口IP `10.0.1.2`（间接交付）
- 第三行：`172.16.0.0/16` 需要通过 R3 转发，下一跳填写 R3 的直连接口IP `172.16.1.2`（间接交付）
- 第四行：`0.0.0.0/0` 是默认路由，所有不匹配的分组都转发给 `10.0.1.2`

## 转发逻辑 ⚠️ **易错点**

### 路由器视角

**关键原则**：写转发表时必须以**当前路由器**的视角看世界。

### 直接交付 vs 间接交付

1. **直接相连**
   - 如果目的IP所属的网络与当前路由器**直接相连**
   - 则**直接交付**（在表中体现为接口编号）
   - 不需要经过其他路由器

2. **间接相连**
   - 如果目的网络不直接相连，则需要查找**下一跳路由器**
   - **关键点**：下一跳地址必须是与当前路由器**直接相连**的那个路由器接口的IP地址
   - 即同一个网段内的地址，**不能跨越路由器去指定更远的地址**

### 示例

假设路由器 R1 通过接口1（IP: `192.168.1.1`）连接到路由器 R2 的接口（IP: `192.168.1.2`），那么：
- ✅ 正确：R1 的转发表中，下一跳应该填 `192.168.1.2`（R2 的直连接口）
- ❌ 错误：不能填 R2 后面的其他路由器IP（如 `10.0.0.1`）

