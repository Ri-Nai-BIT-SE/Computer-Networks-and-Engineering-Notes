# 4.6.4 外部网关协议 BGP (Border Gateway Protocol) ⭐⭐⭐ **高频考点**

## 1. 协议概述

- **全称**：边界网关协议 (Border Gateway Protocol)。
- **地位**：目前互联网中**唯一**被广泛使用的外部网关协议（EGP），版本为 **BGP-4**。
- **作用**：用于在**不同自治系统 (AS)** 之间交换路由信息。
- **核心目标**：力求寻找一条**能够到达目的网络**且**比较好**的路由（即不兜圈子），而**并非**要寻找一条最佳路由。

## 2. 为什么需要 BGP？(与 IGP 的区别)

互联网的规模太大，且各 AS 之间存在管理和策略上的差异，导致 RIP 或 OSPF 不适用：

1. **规模问题**：互联网中的路由表非常大，且子网数量巨大，使用链路状态（如 OSPF）计算最短路径的代价太高。
2. **策略问题 (核心)**：AS 之间的路由选择不仅仅是基于技术指标（如带宽、延迟），更多是基于**政治、安全、经济**等策略。
   - *例如：* 国内的数据流量可能不允许经过某些特定国家的中转；某些商业 ISP 可能拒绝转发竞争对手的流量。

## 3. BGP 的主要特点 ⭐⭐ **必背考点**

1. **类型**：**路径向量 (Path Vector)** 路由选择协议（这是 BGP 与 RIP/OSPF 最本质的区别）。
2. **封装**：BGP 报文封装在 **TCP** 报文中传送（端口号 **179**）。
   - *意义：* 利用 TCP 的可靠传输机制，BGP 不需要自己设计可靠传输（如重传、确认）。
3. **更新机制**：
   - BGP 刚刚运行时，交换整个路由表。
   - 以后只需要在**发生变化时**，交换**有变化**的部分（增量更新），以节省网络带宽和处理开销。
4. **支持 CIDR**：BGP-4 支持无分类编址，路由表中包含网络前缀和子网掩码。

## 4. 工作原理

1. **BGP 发言者 (BGP Speaker)**：
   - 每个 AS 至少选择一个路由器作为"BGP 发言者"（通常是边界路由器）。
   - 两个 BGP 发言者通过 TCP 连接建立会话，交换路由信息。

2. **路径向量 (Path Vector)**：
   - BGP 交换的路由信息包含了**到达目的网络所经过的自治系统序列**（AS-PATH）。
   - *例子：* `[目的网络 N, 路径: AS1 -> AS3 -> AS5]`。

3. **防环机制 (重要)**：
   - 当一个路由器收到一条路由更新时，会检查路径属性中的 **AS-PATH**。
   - 如果发现**自己的 AS 号**已经存在于路径列表中，说明发生了环路，直接**丢弃**该路由。

## 5. BGP 的四种报文 ⭐⭐ **考点**

BGP 协议通过四种报文进行运行和维护：

| 报文类型 | 作用 | 备注 |
| :--- | :--- | :--- |
| **OPEN (打开)** | 用于与相邻的 BGP 发言者建立关系。 | 初始化通信，协商参数。 |
| **UPDATE (更新)** | 用来通告某一路由的信息，以及列出要撤销的多条路由。 | **核心报文**，发送路由更新。 |
| **KEEPALIVE (保活)** | 周期性发送，证实邻居的可达性。 | 维持 TCP 连接，代替 ACK 确认 OPEN 报文。 |
| **NOTIFICATION (通知)** | 用来发送检测到的差错。 | 发送后通常会关闭连接。 |

## 6. 三种协议核心对比 ⭐⭐⭐ **必背考点**

| 维度 | RIP | OSPF | BGP |
| :--- | :--- | :--- | :--- |
| **范围** | 内部网关协议 (IGP) | 内部网关协议 (IGP) | **外部网关协议 (EGP)** |
| **算法** | 距离向量 | 链路状态 | **路径向量** |
| **封装** | UDP (520) | IP (89) | **TCP (179)** |
| **度量** | 跳数 | 带宽/延迟等代价 | **策略 / 属性 (AS-Path)** |
| **目标** | 最小跳数 | 代价最低 | **策略控制，无环路** |

## 7. 复习提示 (Checklist)

- [ ] 能够解释为什么 BGP 使用 TCP 而不是 UDP（需要可靠传输，且跨越网络跳数多，不适合简单的重传）。
- [ ] 理解 BGP 为什么叫"路径向量"？（因为它传播的是一串 AS 路径，而不是单纯的距离数字）。
- [ ] 记住 BGP 报文的四种类型，特别是 KEEPALIVE 的作用。
- [ ] 理解 BGP 的核心目标不是寻找最佳路由，而是寻找能够到达且比较好的路由（策略优先）。
- [ ] 掌握 BGP 的防环机制（检查 AS-PATH 中是否包含自己的 AS 号）。

## 交互式演示

下面是一个交互式演示，可以观察 BGP 协议的路由通告过程和 AS-PATH 的构建：

<BGPSimulation />

