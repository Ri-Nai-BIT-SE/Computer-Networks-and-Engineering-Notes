# 4.6.3 内部网关协议 OSPF (Open Shortest Path First) ⭐⭐⭐ **高频考点**

## 1. 协议概述

- **全称**：开放最短路径优先 (Open Shortest Path First)。
  - **"开放"**：指协议标准是公开发表的，不受某一家厂商控制。
  - **"最短路径优先"**：使用了 **Dijkstra** 提出的 **最短路径算法 (SPF)**。
- **类型**：**链路状态 (Link State)** 路由协议（注意：RIP是距离向量协议）。
- **适用性**：适用于 **大型** 互联网。
- **封装**：OSPF 直接使用 **IP 数据报** 传送（协议号 **89**），不使用 UDP 或 TCP。

## 2. OSPF 的三个核心要点 ⭐⭐⭐ **考试背诵点**

与 RIP 协议（仅和邻居交换、交换全部信息、定期交换）形成鲜明对比，OSPF 的三个要点是：

1. **向谁发送**：使用 **洪泛法 (Flooding)** 向本自治系统中 **所有** 路由器发送信息。
   - *原理：* 路由器通过所有输出端口向邻居发送，邻居收到后再向它的邻居发送（不再发给上一跳），像水的涟漪一样扩散。

2. **发送什么**：发送与本路由器 **相邻的所有路由器的链路状态**。
   - *"链路状态"*：说明本路由器和哪些路由器相邻，以及该链路的 **"度量/代价" (Metric/Cost)**。
   - *注意：* RIP 发送的是"我知道的所有路由"，OSPF 发送的是"我知道的局部地图碎片"。

3. **何时发送**：只有当 **链路状态发生变化** 时，才向所有路由器洪泛信息。
   - *补充：* 虽然主要依靠触发更新，但 OSPF 也会每隔一段时间（如30分钟）刷新一次链路状态。

## 3. 工作原理 (LSDB 与 SPF)

1. **链路状态数据库 (LSDB)**：由于各路由器频繁交换链路状态信息，最终所有路由器都能建立一个 **全网一致** 的链路状态数据库。
   - *本质：* LSDB 就是全网的 **拓扑结构图**。

2. **路由计算**：每个路由器以自己为根，根据 LSDB，使用 **SPF 算法** 计算出到每个目的网络的最短路径，构建路由表。
   - *优点：* **收敛速度快**，不会产生路由环路（因为有全局拓扑图）。

## 4. OSPF 的区域划分 (Area)

为了能用于更大规模的网络，OSPF 将一个自治系统 (AS) 再划分为若干个更小的范围，叫做 **区域 (Area)**。

- **目的**：利用洪泛法交换链路状态信息会产生大量通信量，划分区域可以将洪泛限制在区域内部，减少全网通信负担。
- **区域标识**：使用 32 位区域标识符（点分十进制表示）。
- **两类区域**：
  - **主干区域 (Backbone Area)**：标识符为 `0.0.0.0`。用来连接其他区域。
  - **普通区域**：非主干区域。
- **特殊的路由器角色**：
  - **主干路由器 (Backbone Router)**：在主干区域内的路由器。
  - **区域边界路由器 (ABR)**：连接主干区域和其他区域的路由器。
  - **自治系统边界路由器 (ASBR)**：连接本 AS 和其他 AS 的路由器。

## 5. OSPF 的五种分组类型

OSPF 不像 RIP 那样只有一种更新报文，它通过 5 种分组来实现复杂的功能（注意：OSPF 也是基于请求-响应模式的）：

1. **问候 (Hello) 分组**：用来发现和维持邻站的可达性（周期性发送，通常10秒）。
2. **数据库描述 (Database Description, DD) 分组**：向邻居发送自己 LSDB 中所有链路状态项目的摘要（摘要信息）。
3. **链路状态请求 (Link State Request, LSR) 分组**：向邻居请求某些特定链路状态项目的详细信息。
4. **链路状态更新 (Link State Update, LSU) 分组**：用链路状态的详细信息回答 LSR 请求（这是最核心的更新报文）。
5. **链路状态确认 (Link State Acknowledgment, LSAck) 分组**：对收到的 LSU 进行确认，保证传输可靠性。

## 6. OSPF 与 RIP 的核心对比 ⭐⭐ **高频考点**

| 特性 | RIP (距离向量) | OSPF (链路状态) |
| :--- | :--- | :--- |
| **交换对象** | 仅相邻路由器 | 全网所有路由器 (洪泛) |
| **交换内容** | 完整的路由表 | 局部的链路状态 |
| **度量值** | 跳数 (Hop) | 代价 (Cost，带宽等) |
| **收敛速度** | 慢 (坏消息传得慢) | **快** |
| **路由环路** | 可能出现 (限制最大15跳) | **无环路** (基于拓扑图计算) |
| **适用规模** | 小型网络 | 大型网络 |
| **封装方式** | UDP (520) | IP (89) |

## 7. 复习提示 (Checklist)

- [ ] 能说出 OSPF 的三个核心要点（洪泛、链路状态、变化时）。
- [ ] 理解为什么 OSPF 收敛快且无环路（因为每个路由器都有全网地图）。
- [ ] 知道划分区域的作用（减小 LSDB 规模，减少通信量）。
- [ ] 记住 Hello 分组的作用（发现和维持邻居）。
- [ ] 记住 OSPF 是直接封装在 IP 数据报中的。

## 交互式演示

下面是一个交互式演示，可以观察 OSPF 协议的工作流程（Hello、洪泛、SPF计算）：

<OSPFSimulation />

