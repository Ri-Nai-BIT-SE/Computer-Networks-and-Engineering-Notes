# 4.6.2 内部网关协议 RIP (Routing Information Protocol) ⭐⭐⭐ **高频考点**

## 1. 协议概述

- **定义**：一种分布式的、基于 **距离向量 (Distance Vector)** 算法的路由选择协议。
- **地位**：互联网的标准协议，属于内部网关协议 (IGP)。
- **特点**：简单，但只适用于 **小型** 互联网。
- **封装**：RIP 报文封装在 **UDP** 数据报中进行传输（端口号 **520**）。

## 2. "距离" (Distance) 的定义 ⭐ **考点**

- **度量标准**：使用 **"跳数" (Hop Count)** 来衡量到达目的网络的距离。
- **计算规则**：
  - 路由器到 **直接连接** 的网络：距离 = 1。
  - 路由器到 **非直连** 网络：距离 = 所经过的路由器数 + 1。
  - *注：每经过一个路由器，跳数加 1。*
- **最大限制**：
  - 一条路径最多包含 15 个路由器。
  - **距离 = 16 表示不可达**（网络故障或距离太远）。
- **路由选择依据**：优先选择跳数最少的路径（即便这条路径的带宽很低）。

## 3. RIP 协议的三个要点 ⭐⭐⭐ **考试背诵点**

RIP 协议的运行特点可以总结为以下三句话：

1. **仅和相邻路由器交换信息**：不和陌生的、非直连的路由器通信。
2. **交换什么信息**：交换当前本路由器所知道的 **全部信息**（即自己的整张路由表）。
3. **何时交换信息**：按 **固定时间间隔** 交换（例如每隔 **30秒**）。
   - *补充：* 当网络拓扑发生变化时，路由器也会及时向邻居发送更新报文。

## 4. 距离向量算法 ⭐⭐⭐ **核心计算题**

这是本节最容易出大题的地方。题目通常会给出"路由器A收到邻居B发来的路由信息"，让你更新A的路由表。

### 算法步骤

1. **修改邻居发来的表**：
   - 将收到的 RIP 报文中的所有项目，把 **"下一跳"** 字段改为发送该报文的邻居路由器的地址（例如 X）。
   - 把所有的 **"距离"** 字段的值 **加 1**。

2. **与本地路由表进行比较（更新逻辑）**：
   - **情况1（新路由）**：原路由表中 **没有** 目的网络 N → **直接添加** 该项目。
   - **情况2（同一来源）**：原路由表中有目的网络 N，且 **下一跳就是 X** → **无条件更新**（以此为准，哪怕距离变长了也要改，因为这是最新消息）。
   - **情况3（更优路径）**：原路由表中有目的网络 N，下一跳不是 X，但新路由的 **距离更短** → **更新**（发现了更好的路）。
   - **情况4（无优势）**：原路由表中有目的网络 N，下一跳不是 X，且新路由距离一样或更长 → **什么也不做**。

3. **失效处理**：若 3 分钟（180秒）未收到相邻路由器的更新，则判定该邻居不可达（将距离置为 16）。

## 交互式演示

下面是一个交互式演示，可以逐步观察 RIP 协议的路由表交换和更新过程：

<RIPSimulation />

## 5. RIP2 报文 (RIPv2) ⭐ **选择题/填空题考点**

> **注意**：不需要背诵具体的报文格式图，但必须掌握关键特征和改进点。

### 核心知识点（必考）

1. **最大的改进：支持 CIDR (无分类编址)**
   - **原因**：RIP1 是有分类的（A/B/C类），不携带子网掩码。
   - **RIP2的变化**：在路由信息中增加了 **"子网掩码"** 字段。这是 RIP2 最本质的区别。
   - *老师原话：* "RIP2的最大特点就是它支持CIDR"

2. **封装方式**
   - RIP 报文是封装在 **UDP 数据报** 中的。
   - 端口号是 **520**。
   - *⚠️ 易错点：* 常用来混淆 OSPF（IP协议，协议号89）和 BGP（TCP协议，端口179）。

3. **容量限制**
   - 一个 RIP 报文最多包含 **25 个** 路由信息。
   - 如果路由表很大，需要发送多个 RIP 报文。

4. **其他改进（了解即可）**
   - 支持 **简单的鉴别（Authentication）**，安全性提高。
   - 支持 **多播 (Multicast)** 更新，不再是单纯的广播。

### 报文结构（了解即可）

- **首部**：只有 **三个字段**（老师原话："它的首部只有三个字段... 大家看一看就行了"）
- **路由部分**：包含最多 25 个路由信息，每个路由信息包含目的网络、子网掩码、下一跳、距离等字段。
- *注：* 具体字段格式不需要背诵，考试重点在于理解 RIP2 的改进点。

## 6. RIP 的优缺点

| 优点 | 缺点 |
| :--- | :--- |
| **实现简单**，开销较小。 | **网络规模受限**：最大距离 15，无法用于大型网络。 |
| | **开销较大**：随着网络扩大，交换的是完整的路由表，占用带宽。 |
| | **坏消息传播得慢 (慢收敛)**：当网络出现故障时，需要经过多轮交换才能让所有路由器知道"不可达"，期间可能发生路由环路（Count-to-Infinity，计数到无穷大问题）。 |

## 7. 老师强调的易错点 ⚠️

1. **视角问题**：在做路由表更新题目时，一定要站在 **正在更新的那个路由器** 的视角看世界。
   - *例如：* R1 收到 R2 发来的表，R1 就要把发来的表里的所有"下一跳"都改成 R2，距离都 +1，然后再跟自己手里的牌（旧表）比对。

2. **下一跳的填写**：在 RIP 算法中，直连网络的下一跳通常写"直接交付"或接口号；非直连网络填的是 **邻居路由器的接口 IP**。

3. **不可达的定义**：距离 16 即为不可达，不要写成 15。

## 8. 复习要点：为什么"好消息传得快，坏消息传得慢"？

### 核心理解

简单来说，这句话的意思是：
- **好消息**：当网络中出现了一条新路径，大家都更新得很快。
- **坏消息**：当网络中某条路径断了，路由器之间会因为互相"欺骗"，导致大家要过很久才知道这条路真的断了。

### 通俗例子

想象一个城市的路况系统：

**好消息场景（新路开通）**：
- 假设从A到B原来要经过3个路口（距离=4）。
- 突然开通了一条直达路（距离=1）。
- A立即告诉邻居："我发现到B只要1步！"
- 邻居收到后立即更新："太好了，我通过A到B只要2步！"
- 消息像病毒一样快速传播，**一次更新就传遍全网**。

**坏消息场景（路断了）**：
- 假设从A到B的路突然断了。
- A不知道路断了，还以为可以通过C到达B（A→C→B，距离=3）。
- A告诉邻居："我通过C到B只要3步！"
- 但C其实也是通过A到B的（C→A→B，距离=3）。
- 结果：A和C互相"欺骗"，都以为对方有路可走。
- 每次交换，距离都+1：3→4→5→...→15→16（不可达）。
- 这个过程需要**多轮交换**才能收敛，非常慢。

### 技术图解

```
初始状态（路正常）：
A ←→ B（距离=1）
A ←→ C（距离=1）
C ←→ B（距离=1）

A的路由表：到B距离=1，下一跳=B
C的路由表：到B距离=1，下一跳=B

---

场景1：好消息（发现更短路径）
A发现：通过C到B距离=2（A→C→B）
但A已经有直接到B的路（距离=1），所以不更新。
✅ 一次更新完成，快速收敛。

场景2：坏消息（A-B链路断开）
第1轮交换：
  A告诉C："我到B距离=1"（A还不知道路断了）
  C告诉A："我到B距离=1"（C也不知道路断了）
  → A和C都以为对方有路可走

第2轮交换：
  A发现：通过C到B距离=2（A→C→B，但C其实也是通过A的）
  C发现：通过A到B距离=2（C→A→B，但A其实也是通过C的）
  → 距离变成2

第3轮交换：
  A发现：通过C到B距离=3
  C发现：通过A到B距离=3
  → 距离变成3

...（继续增加）

第15轮交换：
  A发现：通过C到B距离=15
  C发现：通过A到B距离=15
  → 距离变成15

第16轮交换：
  A发现：通过C到B距离=16（不可达！）
  C发现：通过A到B距离=16（不可达！）
  → 终于知道路断了

❌ 需要16轮交换才能收敛，非常慢！
```

### 总结

- **好消息（新路径）**：可以通过一次更新迅速传播，**O(1)时间复杂度**。
- **坏消息（路径断开）**：需要经过多轮交换，距离从1逐渐增加到16，**O(n)时间复杂度**，其中n是最大跳数（15）。
- **根本原因**：RIP协议中，路由器不知道完整的网络拓扑，只能根据邻居的信息进行推断，导致"互相欺骗"的问题。

