# 5.8.3 主动队列管理 AQM (Active Queue Management)

这一节是第五章的**收尾部分**，它把视角从"发送方（TCP）"转到了"网络核心（路由器）"。

* **TCP 拥塞控制 (5.8.2)**：是**端系统**（电脑/手机）自己在努力，觉得自己发快了就减速。
* **AQM (5.8.3)**：是**路由器**在努力，当路由器发现自己快堵死的时候，主动丢弃一些包，给 TCP 发送方报信。

这一节在考试中主要考**概念理解**，特别是**"尾部丢弃"带来的严重后果——全局同步**。

---

## 🟢 [交互演示]：尾部丢弃 vs RED

这个演示能让你一眼看穿为什么要用 RED。

<AQMDemo />

**操作说明**：
1. 选择 **"尾部丢弃"**：疯狂点击"有分组到达"，你会发现只有满了才会红（丢包）。
2. 选择 **"RED 算法"**：点击"有分组到达"，你会发现在**黄色区域（警戒区）**时，偶尔会有包变红（随机丢弃）。这就是在"敲打"发送方。

---

## 📚 核心考点笔记

### 1. 传统的笨办法：尾部丢弃 (Tail Drop)

在 AQM 出现之前，路由器处理拥塞的策略非常简单粗暴：

* **策略**：只要路由器的队列（缓存）没满，就收下；**一旦满了，后面来的包统统扔掉**。
* **公式**：
  $$
  \text{丢弃策略} = \begin{cases}
  \text{接收} & \text{当 } L < L_{max} \\
  \text{丢弃} & \text{当 } L \geq L_{max}
  \end{cases}
  $$
  其中 $L$ 是当前队列长度，$L_{max}$ 是队列最大容量。

* **严重后果：全局同步 (Global Synchronization)** (★ 必考名词)
  * 当队列满时，路由器会丢弃**所有**正在发送数据的主机的报文（不管你是谁）。
  * **结果**：所有 TCP 发送方同时发现丢包 → 所有方同时超时 → **所有方同时进入慢开始（cwnd 降为 1）**。
  * **震荡**：网络流量瞬间跌入谷底，然后又慢慢一起恢复，再一次一起堵死。这种全网忽高忽低的现象就是全局同步。

### 2. 聪明的办法：主动队列管理 (AQM)

为了避免"一刀切"导致的全局同步，路由器决定**"主动"**一点。

* **核心思想**：不要等队列满了再丢，而是**在队列快要满的时候，就随机丢弃一些包**。
* **目的**：提前让个别 TCP 发送方感知到拥塞，让它们个别减速，从而避免大家一起减速。

#### 代表算法：RED (Random Early Detection, 随机早期检测)

虽然现在有更新的算法，但课本和考试主要讲 RED。它引入了三个参数：

1. **最小门限 ($Th_{min}$)**：队列长度低于它，完全不丢。
2. **最大门限 ($Th_{max}$)**：队列长度高于它，强制全丢（和尾部丢弃一样）。
3. **丢弃概率 ($p$)**：当队列长度在两者**之间**时，按照概率 $p$ **随机**丢包。

**RED 算法的丢弃策略**：

$$
\text{丢弃策略} = \begin{cases}
\text{不丢弃} & \text{当 } L < Th_{min} \\
\text{按概率 } p \text{ 随机丢弃} & \text{当 } Th_{min} \leq L < Th_{max} \\
\text{强制丢弃} & \text{当 } L \geq Th_{max}
\end{cases}
$$

其中 $L$ 是当前队列长度（或平均队列长度）。

**丢弃概率 $p$ 的计算**（简化理解）：
- 队列长度越接近 $Th_{max}$，丢弃概率越大。
- 通常使用线性增长：$p \propto (L - Th_{min}) / (Th_{max} - Th_{min})$

**为什么要计算"平均队列长度"？**
- 为了过滤掉网络中**短暂的抖动**。如果只是来了一波突发流量（Burst），马上就走了，RED 不希望误判为拥塞。只有平均长度上来了，才开始丢包。

---

## 🎓 考试必背考点

### 考点一：为什么会有"全局同步"？（简答题/选择题）

* **原因**：路由器的 **尾部丢弃 (Tail Drop)** 策略。
* **过程**：
  1. 队列满
  2. 丢弃**所有**后续到达的包
  3. **所有** TCP 连接同时超时
  4. **所有** TCP 同时进入慢开始（减速）
  5. 流量骤降
  6. 同时恢复
  7. 再次同时拥塞
* **关键词**：**同时超时、全网震荡**。

### 考点二：RED 算法的原理

* 不要死记公式，记住**"分区"**：
  1. **正常区** ($L < Th_{min}$)：**不丢**。
  2. **拥塞区** ($L > Th_{max}$)：**全丢** (和尾部丢弃一样)。
  3. **随机区** (中间)：**按概率丢**。

### 考点三：AQM 的目的

* **题目**：主动队列管理 AQM 的目的是什么？
* **答**：
  1. 避免全局同步
  2. 提前让个别 TCP 发送方感知到拥塞
  3. 让网络负载曲线变平滑，而不是大起大落

### 考点四：RED 算法的参数

* **题目**：RED 算法有哪些关键参数？
* **答**：
  1. $Th_{min}$：最小门限（安全区上限）
  2. $Th_{max}$：最大门限（警戒区上限）
  3. $p$：丢弃概率（在警戒区内）

### 考点五：平均队列长度的作用

* **题目**：RED 算法为什么要使用平均队列长度而不是瞬时队列长度？
* **答**：为了过滤掉网络中**短暂的抖动**（突发流量），避免误判为拥塞。只有平均长度持续上升，才开始丢包。

---

## 🎯 易错点提醒

1. **尾部丢弃 vs RED**：
   - 尾部丢弃：只有队列满时才丢，导致全局同步
   - RED：在队列快满时就开始随机丢，避免全局同步

2. **全局同步的定义**：
   - 不是简单的延迟增加
   - 而是所有 TCP 连接同时超时、同时减速、同时恢复的震荡现象

3. **RED 的三个区域**：
   - 绿色区（$L < Th_{min}$）：安全，不丢
   - 黄色区（$Th_{min} \leq L < Th_{max}$）：警戒，随机丢
   - 红色区（$L \geq Th_{max}$）：危险，强制丢

4. **丢弃概率**：
   - 不是固定值，而是随队列长度动态变化
   - 队列越长，丢弃概率越大

5. **平均队列长度**：
   - RED 使用平均队列长度，而不是瞬时队列长度
   - 目的是过滤突发流量，避免误判

---

## 总结

这一节的核心目的就是**"破除同步"**。

**核心要点**：
1. **问题**：尾部丢弃导致全局同步（所有 TCP 同时超时、减速）
2. **解决**：AQM（主动队列管理），代表算法是 RED
3. **原理**：在队列快满时随机丢弃，提前让个别 TCP 减速
4. **效果**：让网络负载曲线变平滑，避免大起大落

通过**随机**丢弃某个人的包，让这个人先减速，其他人继续发，从而让网络的负载曲线变平滑，而不是大起大落。


