# 5.5 TCP 报文段的首部格式

这一节是第五章中**最需要记忆**的部分。TCP 所有的机制（可靠传输、流量控制、拥塞控制、连接管理）都要靠首部里的这些字段来实现。

考试中，这里通常以**填空题**或**综合题的第一问**出现（例如：给出一个抓包截图，问你这是什么报文，序号是多少）。

---

## 1. 总体结构 (★必背数据)

* **固定首部**：前 **20 字节** 是固定的，所有 TCP 报文段必须有。
* **选项 (Options)**：长度可变（0 ~ 40 字节）。
* **最小长度**：20 字节。
* **最大长度**：60 字节（由"数据偏移"字段决定）。

---

## 🟢 [交互演示]：TCP 首部格式图

鼠标悬停在各个字段上，查看详细说明。

<TCPHeaderViewer />

---

## 2. 核心字段详解 (考试必考点)

你需要重点掌握以下几个字段，尤其是**序号、确认号**和**6个控制位**。

### (1) 序号 (Sequence Number, seq) - 4字节

* **含义**：TCP 是面向字节流的，**每一个字节**都有一个序号。
* **填什么**：本报文段数据部分的**第一个字节**的序号。
* *考点*：如果 seq = 301，本报文段数据长度 = 100 字节，那么下一个报文段的 seq 应该是多少？
  - 答案：$301 + 100 = 401$。

### (2) 确认号 (Acknowledgment Number, ack) - 4字节

* **含义**：**期望**收到对方**下一个**报文段的第一个字节的序号。
* **口诀**：**"若确认号为 N，则表明到序号 N-1 为止的所有数据都已正确收到。"**
* *考点*：累积确认机制。

### (3) 数据偏移 (Data Offset) - 4位

* **含义**：其实就是**首部长度**。
* **单位**：**4 字节**。
* **计算**：如果该字段的值是 5 (二进制 0101)，说明首部长度是 $5 \times 4 = 20$ 字节（无选项）。如果值是 15 (1111)，首部长度是 $15 \times 4 = 60$ 字节（最长）。
    
### (4) 6 个控制位 (Flags) ★★★

考试常考选择题，问你某个场景下哪个标志位是 1。

| 标志位 | 英文全称 | 中文 | 作用场景 (考点) |
| :--- | :--- | :--- | :--- |
| **URG** | Urgent | 紧急 | 插队。URG=1 时，紧急指针有效。告诉系统这段数据很急（如 Ctrl+C 中断命令）。 |
| **ACK** | Acknowledgment | 确认 | **建立连接后，所有报文的 ACK 必须置 1**。ACK=0 时，确认号字段无效。 |
| **PSH** | Push | 推送 | 接收方收到 PSH=1 的报文，尽快交给应用进程，不要在缓存里等填满了再交。 |
| **RST** | Reset | 复位 | 连接崩溃（如主机断电重启、非法访问），强制断开连接，不走四次挥手。 |
| **SYN** | Synchronize | 同步 | **三次握手**时用。SYN=1 表示这是一个连接请求或连接接受报文。 |
| **FIN** | Finish | 终止 | **四次挥手**时用。FIN=1 表示数据发完了，要求释放连接。 |

### (5) 窗口 (Window) - 2字节

* **含义**：告诉对方"我的接收缓存还能装多少字节"。
* **作用**：**流量控制**的依据。发送方的发送窗口不能超过接收方给出的这个值。

### (6) 选项 (Options) - **MSS**

* **MSS (Maximum Segment Size)**：最大报文段长度。
* **最大的坑**：MSS 指的是**数据字段**的最大长度，**不包含 TCP 首部**。
  - $TCP 报文段长度 = TCP 首部 + TCP 数据 (MSS)$。
  - 考试如果问你"为了避免 IP 分片，MSS 应该设为多少？"
  - 答案：$MSS = MTU - IP首部(20) - TCP首部(20)$。通常是 1460 字节。

---

## 3. 考试避坑指南

### 考点一：ACK 标志位 vs ack 确认号

* **大写的 ACK** 是 1 位的标志位（开关）。
* **小写的 ack** 是 32 位的确认号数值。
* 只有当 **ACK=1** 时，**ack** 才有效。

### 考点二：序号的计算

* **题目**：A 发送 seq=100, len=200 的报文给 B。B 收到后发回的确认号 ack 是多少？
* **答**：$100 + 200 = 300$。B 期待收到 300。

### 考点三：首部长度

* **题目**：数据偏移字段是 1000 (二进制)，求首部长度。
* **答**：1000 是十进制的 8。$8 \times 4字节 = 32字节$。说明有 12 字节的选项（32 - 20 = 12）。

### 考点四：MSS 的计算

* **题目**：MTU = 1500 字节，IP 首部 20 字节，TCP 首部 20 字节，求 MSS。
* **答**：$MSS = 1500 - 20 - 20 = 1460$ 字节。

### 考点五：标志位的组合

* **三次握手**：
  - 第一次：SYN=1, ACK=0
  - 第二次：SYN=1, ACK=1
  - 第三次：SYN=0, ACK=1
* **四次挥手**：
  - 第一次：FIN=1, ACK=1
  - 第二次：ACK=1
  - 第三次：FIN=1, ACK=1
  - 第四次：ACK=1

---

## 🎓 记忆技巧

1. **首部结构记忆**：端口(2行) → 序号(1行) → 确认号(1行) → 控制字段(1行) → 检验和(1行) → 选项(可选)

2. **6个标志位记忆**：**UAPRSF** (Urgent, Acknowledgment, Push, Reset, Synchronize, Finish)

3. **序号和确认号**：
   - 序号：我发的数据从第几个字节开始
   - 确认号：我期望收到你从第几个字节开始的数据

4. **数据偏移**：记住单位是4字节，最大值15表示60字节
