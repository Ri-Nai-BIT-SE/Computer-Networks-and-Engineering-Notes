# 5.6.1 以字节为单位的滑动窗口

**5.6.1 以字节为单位的滑动窗口** 是 TCP 可靠传输的核心实现机制。

这一节的**核心考点**在于理解三个指针 **P1, P2, P3** 的位置关系，以及发送窗口是如何随着数据的发送和 ACK 的接收而"滑动"的。

---

## 🟢 [交互演示]：TCP 滑动窗口模拟器

下面是一个交互式的滑动窗口模拟器，模拟了发送方的视角。你可以通过点击按钮观察窗口如何滑动。

<TCPSlidingWindow />

**操作说明**：
1. 点击"发送 1 字节"按钮，观察 P2 指针向右移动，可用窗口变小
2. 点击"收到 1 字节 ACK"按钮，观察 P1 和 P3 指针向右移动，窗口滑动
3. 观察不同颜色的字节块：
   - **灰色**：已确认（P1 左边）
   - **红色**：已发送未确认（P1 和 P2 之间）
   - **青色**：可用窗口（P2 和 P3 之间）
   - **白色**：不允许发送（P3 右边）

---

## 📚 理论精讲

在看完上面的演示后，请对照教材的图 5-15，记住以下 **3 个指针** 和 **3 个概念**。这在综合题中经常让你分析数值。

### 1. 三个指针的含义 (考试重点)

#### P1 (后沿/Back edge)

* **指向**：**发送窗口的第一个字节**。
* **含义**：
  - 它的左边是 **"已发送且已确认"** 的数据（不用管了）。
  - 它自己是 **"已发送但未收到确认"** 的第一个字节。
* **动作**：只有收到新的 **ACK**，P1 才能向右移动（窗口滑动）。

#### P2 (当前发送指针)

* **指向**：**"允许发送但尚未发送"** 的第一个字节。
* **含义**：
  - P1 和 P2 之间的部分（红色块）是 **"已发送但未收到确认"** 的数据。
  - P2 和 P3 之间的部分（青色块）是 **"可用窗口"**。
* **动作**：每发送一个字节，P2 向右移动一格。

#### P3 (前沿/Front edge)

* **指向**：**发送窗口的界限外**。
* **公式**：`P3 = P1 + 发送窗口大小`。
* **含义**：
  - P2 和 P3 之间的部分（青色块）是 **"可用窗口" (Usable Window)**，即你现在还能发多少数据。
  - P3 右边是 **"不允许发送"** 的区域。

### 2. 发送窗口的计算公式 (必背)

在综合题中，题目通常会给你 `P1`, `P2`, `P3` 的序号值，让你计算：

1. **已发送但未被确认的字节数** = $P2 - P1$
2. **允许发送但尚未发送的字节数（可用窗口）** = $P3 - P2$
3. **发送窗口的总大小** = $P3 - P1$

**记忆技巧**：
- 已发送未确认 = 当前发送位置 - 后沿
- 可用窗口 = 前沿 - 当前发送位置
- 窗口大小 = 前沿 - 后沿

### 3. 窗口滑动的逻辑

#### 发送数据时

* **动作**：发数据 -> `P2` 动，`P1` 不动。
* **结果**：可用窗口变小（P3 - P2 减小）。

#### 收到 ACK 时

* **动作**：收到 ACK -> 告诉发送方 `P1` 可以动了。
* **结果**：
  - 发送方 `P1` 向右动。
  - 因为窗口大小通常固定（流量控制前），`P3` 也跟着向右动（P3 = P1 + 窗口大小）。
  - **结果**：又有新的字节（右边的白色块）进入了窗口，变成了可发送状态（青色块）。

#### 窗口滑动的完整过程

1. **初始状态**：P1 = P2 = 0，P3 = 窗口大小
2. **发送数据**：P2 向右移动，可用窗口减小
3. **收到 ACK**：P1 向右移动，P3 也向右移动（保持窗口大小不变）
4. **重复**：继续发送数据，窗口继续滑动

---

## 🎓 考试避坑指南

### 考点一：单位问题

* **TCP 的滑动窗口是 "以字节为单位"**，不是以报文段为单位。
* 题目如果说 "窗口大小为 20"，指的是 20 **字节**。

### 考点二：P2 和 P3 重合

* 如果 `P2 == P3`，说明 **"可用窗口 = 0"**。
* 此时发送方必须**停止发送**，等待 ACK。
* 这是流量控制的核心机制。

### 考点三：确认号的含义

* 如果 P1 指向 31，说明 31 还没收到确认。
* 如果此时收到了 `ACK = 34`，说明 31, 32, 33 都收到了。
* **P1 应该直接跳到 34**（累积确认机制）。

### 考点四：计算题

**例题**：已知 P1 = 100, P2 = 105, P3 = 110，求：
1. 已发送但未被确认的字节数
2. 可用窗口大小
3. 发送窗口大小

**解**：
1. 已发送但未被确认 = P2 - P1 = 105 - 100 = 5 字节
2. 可用窗口 = P3 - P2 = 110 - 105 = 5 字节
3. 发送窗口大小 = P3 - P1 = 110 - 100 = 10 字节

### 考点五：窗口滑动后的计算

**例题**：初始状态 P1 = 0, P2 = 0, P3 = 10。发送了 3 个字节后，收到 ACK = 2，求新的 P1, P2, P3。

**解**：
- 发送 3 个字节后：P1 = 0, P2 = 3, P3 = 10
- 收到 ACK = 2，说明 0, 1 已确认，P1 跳到 2
- 新的状态：P1 = 2, P2 = 3, P3 = 12（P1 + 窗口大小 = 2 + 10 = 12）

---

## 🎯 易错点提醒

1. **P3 是计算出来的**：P3 = P1 + 窗口大小，不是独立的变量。

2. **窗口大小通常固定**：在流量控制之前，发送窗口大小通常是固定的。收到 ACK 后，P1 和 P3 一起向右移动。

3. **可用窗口为 0 时停止发送**：当 P2 = P3 时，必须等待 ACK，不能继续发送。

4. **累积确认的影响**：收到 ACK = N 时，P1 直接跳到 N，不是只移动 1 位。

5. **与流量控制的关系**：实际的发送窗口 = min(接收方窗口, 拥塞窗口)。这里先学基础概念，后面会结合流量控制和拥塞控制。


