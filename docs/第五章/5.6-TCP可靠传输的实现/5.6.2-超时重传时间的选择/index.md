# 5.6.2 超时重传时间的选择

这一节主要解决一个核心矛盾：**TCP 的超时计时器（RTO）到底应该设多长？**

* **太短**：网络稍微卡一下，还没等到 ACK 就误以为丢了，导致**不必要的重传**，增加网络负担。
* **太长**：真丢包了，发方还要傻等很久才发现，导致**传输效率降低**。

这一节的核心考点在于**"计算公式"**（不用死算，但要懂原理）和**"Karn 算法"**（解决重传歧义）。

---

## 🟢 [交互演示]：RTO 自适应计算模拟器

这个模拟器完全遵循 **RFC 6298** 标准算法。你可以输入不同的 `SampleRTT`（比如模拟网络突然变卡），看看 `RTO` 是如何平滑变化的。

<TCPRTOCalculator />

**操作说明**：
1. 输入一个 RTT 测量值（例如：100ms），点击"输入本次测量的 RTT"
2. 观察 RTTs、RTTd 和 RTO 的变化
3. 尝试输入不同的值（如 50ms、200ms），观察 RTO 如何自适应调整
4. 查看历史记录，了解每次计算的过程

---

## 📚 核心考点笔记

### 1. 为什么不能直接用测出来的 RTT 当 RTO？

* **网络有抖动**。这次 10ms，下次可能 100ms。如果直接用 10ms 做超时时间，下次 100ms 的包还没到就超时重传了。
* **解决**：我们需要一个**加权平均值**（去掉毛刺，保留趋势）。

### 2. 两个关键变量 (了解即可，不用死算)

#### RTTs (加权平均往返时间)

* **含义**：反应了当前网络的**平均**延迟水平。
* **公式**：
  $$NewRTT_S = (1-\alpha) \times OldRTT_S + \alpha \times SampleRTT$$
* **考点**：$\alpha$ 推荐值为 **1/8 (0.125)**。这意味着它更相信"历史经验"，而不是"单次测量"。
* **理解**：
  - $\alpha$ 越小，历史值权重越大，对新测量值不敏感（平滑）
  - $\alpha$ 越大，新测量值权重越大，对网络变化更敏感（快速响应）

#### RTTd (RTT 的偏差)

* **含义**：反应了网络的**波动**程度（方差）。
* **公式**：
  $$NewRTT_D = (1-\beta) \times OldRTT_D + \beta \times |SampleRTT - RTT_S|$$
* **考点**：$\beta$ 推荐值为 **1/4 (0.25)**。
* **理解**：网络越不稳定，这个值越大，安全余量就要留得越多。

### 3. 最终 RTO 的计算公式 (★ 必背公式)

考试如果出计算题，90% 都是考这个公式：

$$RTO = RTT_S + 4 \times RTT_D$$

* **含义**：超时时间 = 平均时间 + 4倍的波动范围。
* **为什么要乘 4？** 为了留足安全余量，宁可稍微慢点重传，也不要频繁误判。
* **考点**：记住系数是 **4**，不是 2 也不是 8。

### 4. 第一次测量的特殊处理

* **RFC 规定**：第一次测量时，直接使用测量值。
  - $RTT_S = SampleRTT$
  - $RTT_D = SampleRTT / 2$
  - $RTO = RTT_S + 4 \times RTT_D$

### 5. Karn 算法 (Karn's Algorithm) (★ 逻辑题考点)

这是一个非常经典的逻辑陷阱。

#### 问题场景

* **场景**：发送方发了 M1，超时了，重传 M1。过了一会儿收到一个 ACK。
* **歧义**：这个 ACK 是确认**第一次**发的 M1，还是**重传**的 M1？发送方根本不知道。
* **后果**：如果算错了，会导致 $RTT_S$ 计算严重失真。

#### Karn 算法的规则

1. **只要报文段重传了，就不使用这次的测量结果来计算 $RTT_S$。** (直接无视，不采样)
2. **修正**：报文每重传一次，就把 $RTO$ 时间 **x2 (翻倍)**。这叫**指数退避 (Exponential Backoff)**。

#### 示例

* 初始 RTO = 100ms
* 第一次超时：RTO = 200ms (翻倍)
* 第二次超时：RTO = 400ms (再翻倍)
* 第三次超时：RTO = 800ms (再翻倍)

**目的**：避免在网络拥塞时，频繁重传导致网络更加拥塞。

---

## 🎓 考试避坑指南

### 考点一：RTO 计算公式

* **题目**：已知 $RTT_S = 100ms$，$RTT_D = 20ms$，求 RTO。
* **答**：$RTO = 100 + 4 \times 20 = 180ms$

### 考点二：加权平均的计算

* **题目**：$OldRTT_S = 100ms$，$SampleRTT = 150ms$，$\alpha = 0.125$，求新的 $RTT_S$。
* **答**：$NewRTT_S = (1-0.125) \times 100 + 0.125 \times 150 = 0.875 \times 100 + 18.75 = 87.5 + 18.75 = 106.25ms$

### 考点三：Karn 算法

* **题目**：TCP 发送方重传了一个报文段，应该如何处理这次测量的 RTT？
* **答**：**不使用**这次测量的 RTT 来计算 $RTT_S$，并且将 RTO **翻倍**。

### 考点四：指数退避

* **题目**：初始 RTO = 200ms，连续超时 3 次，求最终的 RTO。
* **答**：
  - 第1次超时：200 × 2 = 400ms
  - 第2次超时：400 × 2 = 800ms
  - 第3次超时：800 × 2 = 1600ms
  - 最终 RTO = 1600ms

---

## 🎯 易错点提醒

1. **系数记忆**：
   - $\alpha = 1/8 = 0.125$（用于 RTTs 计算）
   - $\beta = 1/4 = 0.25$（用于 RTTd 计算）
   - RTO 公式中的系数是 **4**（不是 2 或 8）

2. **第一次测量**：第一次测量时，$RTT_D = SampleRTT / 2$，不是直接用测量值。

3. **Karn 算法**：
   - 重传的包**不采样**（不用于计算 RTTs）
   - 超时后 RTO **翻倍**（指数退避）

4. **RTO 的下限**：通常 RTO 不能小于某个最小值（如 1 秒），避免过于频繁的重传。

5. **RTO 的上限**：通常 RTO 不能超过某个最大值（如 60 秒），避免等待时间过长。

---

## 总结

这一节不需要像数学考试那样去推导，你只需要记住：

1. **RTO = 平滑值 + 4倍偏差值**：$RTO = RTT_S + 4 \times RTT_D$
2. **Karn 算法**：重传的包不采样，超时时间要翻倍（指数退避）
3. **加权平均**：更相信历史经验（$\alpha = 0.125$），而不是单次测量


