# 5.6.3 选择确认 SACK (Selective Acknowledgement)

这一节是 TCP 可靠传输机制的**进阶补丁**。

我们在 5.4.2 节学过，如果 1, 2, 4, 5 到了，但 3 丢了，标准的 TCP（累积确认）只能回复 `ACK = 3`。发送方一着急，可能会把 3, 4, 5 全部重传。

**SACK 就是为了解决这个问题：** 它允许接收方告诉发送方，"其实 4 和 5 我已经收到了，你只传 3 就行"。

这一节的考点主要集中在**"SACK 在哪里（选项字段）"**以及**"边界的定义"**。

---

## 🟢 [交互演示]：SACK 块生成模拟器

这个演示模拟了接收方的视角。你可以点击下面的方块，模拟**"丢包"**（变灰）或**"收到"**（变绿）。观察底部的 **ACK** 和 **SACK 选项** 是如何实时变化的。注意观察 SACK 块的"左边界"和"右边界"。

<TCPSACKDemo />

**操作说明**：
1. 点击方块切换状态：绿色表示已收到，灰色表示丢失/未到
2. 观察累积确认号 (ACK) 的变化：ACK 指向第一个未收到的包
3. 观察 SACK 块：当有非连续的数据块时，会生成 SACK 块
4. 蓝色边框表示该包属于某个 SACK 块

---

## 📚 核心考点笔记

### 1. SACK 放在哪里？

* SACK 不是 TCP 固定首部的一部分，它必须放在 **TCP 首部的"选项 (Options)"字段** 中。
* **考点**：如果要使用 SACK，通信双方必须在**建立连接（三次握手）**时，通过 SYN 报文的选项协商好（"我支持 SACK，你也支持吗？"）。
* **位置**：TCP 首部格式中的"选项"字段（见 5.5 节）。

### 2. 边界的定义 (★ 易错点)

每个 SACK 块由两个 32 位的序号（4字节+4字节）定义：

* **左边界 (Left Edge)**：该块的**第一个**字节的序号。
* **右边界 (Right Edge)**：该块的**最后一个**字节的序号 **加 1**。
  * **例子**：如果你收到了序号 1001~1500 的数据块。
  * SACK 选项填：Left=1001, Right=**1501**。
  * **理解**：这和编程里的 `[start, end)` 左闭右开区间是一样的逻辑。

**记忆技巧**：
- 左边界：第一个字节的序号（包含）
- 右边界：最后一个字节的序号 + 1（不包含）
- 实际收到的字节范围：`[Left, Right)` 或 [Left, Right-1]`

### 3. 最多能放几个块？(计算题逻辑)

这是考试中常见的计算题。

* **TCP 首部选项最大长度** = **40 字节**。
* **SACK 选项头部**：
  - 指明"我是 SACK 选项"需要 1 字节
  - 指明"长度"需要 1 字节
  - 共 **2 字节**头
* **剩余空间** = 40 - 2 = **38 字节**。
* **一个 SACK 块的大小**：
  - 需要 2 个序号（左边界+右边界）
  - 每个序号 4 字节
  - 共 $4+4=8$ 字节
* **计算**：$38 \div 8 = 4.75$。
* **结论**：一个 TCP 报文段最多只能包含 **4 个** SACK 块。

**考点**：记住是 **4 个**，不是 3 个或 5 个。

### 4. SACK 的工作流程

#### 场景示例

假设发送方发送了序号 1, 2, 3, 4, 5 的数据：
- 接收方收到了 1, 2, 4, 5
- 序号 3 丢失了

#### 标准 TCP（无 SACK）

* 接收方只能发送：`ACK = 3`
* 发送方收到后，不知道 4, 5 是否收到
* 可能重传：3, 4, 5（回退 N）

#### 使用 SACK

* 接收方发送：
  - `ACK = 3`（累积确认）
  - `SACK Block 1: Left=4, Right=6`（表示收到了 4 和 5）
* 发送方收到后，知道：
  - 3 丢失了，需要重传
  - 4, 5 已经收到，不需要重传
* **只重传**：3（选择重传）

### 5. SACK 的优势

* **减少不必要的重传**：只重传真正丢失的数据
* **提高效率**：在网络质量不好时，避免浪费带宽
* **与回退 N 的区别**：回退 N 会重传所有后续数据，SACK 只重传丢失的部分

---

## 🎓 考试避坑指南

### 考点一：SACK 的位置

* **题目**：SACK 选项放在 TCP 首部的哪个字段？
* **答**：**选项 (Options)** 字段

### 考点二：边界的计算

* **题目**：接收方收到了序号 2001~2500 的数据，SACK 块的左边界和右边界分别是多少？
* **答**：
  - 左边界 = 2001
  - 右边界 = 2500 + 1 = **2501**

### 考点三：最多几个 SACK 块

* **题目**：TCP 首部选项最多能包含几个 SACK 块？
* **答**：**4 个**

### 考点四：计算题

* **题目**：TCP 选项字段最大 40 字节，SACK 选项头部 2 字节，每个 SACK 块 8 字节，最多能放几个块？
* **解**：
  - 剩余空间 = 40 - 2 = 38 字节
  - 块数 = 38 ÷ 8 = 4.75
  - 取整 = **4 个**

### 考点五：SACK 与累积确认的关系

* **重要**：SACK 是**补充**，不是**替代**累积确认
* 接收方**必须**发送累积确认号 (ACK)
* SACK 只是**额外**告诉发送方哪些不连续的数据块收到了

---

## 🎯 易错点提醒

1. **右边界是 +1**：右边界 = 最后一个字节序号 + 1，不是最后一个字节序号本身。

2. **SACK 是选项**：SACK 不是 TCP 固定首部的一部分，必须放在选项字段中。

3. **需要协商**：使用 SACK 需要在三次握手时协商，不是默认开启的。

4. **最多 4 个块**：记住是 4 个，不是 3 个或 5 个。

5. **与累积确认配合**：SACK 不能单独使用，必须配合累积确认号 (ACK) 使用。

6. **左闭右开区间**：SACK 块的范围是 `[Left, Right)`，类似于编程中的数组索引。

---

## 总结

考试如果不考具体计算，你只需要记住一句话：

**SACK 是为了让发送方只重传丢失的数据，它放在 TCP 选项里，最多能报告 4 个不连续的碎片。**

**核心要点**：
1. **位置**：TCP 首部选项字段
2. **边界**：左边界是第一个字节，右边界是最后一个字节 + 1
3. **数量**：最多 4 个 SACK 块
4. **作用**：减少不必要的重传，提高传输效率


