# 3.3.2 CSMA/CD协议

## CSMA/CD协议概述

### 全称
- **CSMA/CD**：Carrier Sense Multiple Access with Collision Detection
- **载波监听多点接入/碰撞检测**

### 三个要点

#### 1. 多点接入（MA）
- 多个站点连接在一条总线上
- 总线型网络

#### 2. 载波监听（CS）
- 每个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据
- 如果总线忙，则等待；如果总线空闲，则发送

#### 3. 碰撞检测（CD）
- **定义**：边发送边监听，如果检测到信号电压变化超过一定阈值，就认为总线上至少有两个站同时在发送数据，产生了碰撞
- **处理**：立即停止发送，等待一段随机时间后再次发送

## 争用期（Contention Period）

### 定义
- **争用期**：51.2μs（10Mbit/s以太网）
- **意义**：发送帧后，如果在争用期内没有检测到碰撞，就可以肯定这次发送不会发生碰撞
- **本质**：**往返传播时延** $2\tau$（$\tau$为单程端到端传播时延）

### 计算公式
$$2\tau = 2 \times \frac{\text{距离}}{\text{信号传播速度}}$$

其中：
- 信号在双绞线中的传播速度约为 $2 \times 10^8$ m/s（光速的2/3）
- 信号在光纤中的传播速度约为 $2 \times 10^8$ m/s

### 10Mbps以太网的经典数值
- 争用期 = 51.2μs
- 在争用期内可发送：$10 \times 10^6 \times 51.2 \times 10^{-6} = 512$ bit = **64字节**

### 最短有效帧长 ⭐ **必考计算题**

#### 定义
- **64字节（512 bit）**：如果帧的长度小于64字节，则无法在争用期内完成发送，无法检测碰撞
- **原因**：如果帧太短，发送端可能在发送完之前就检测不到碰撞
- **重要结论**：**凡是长度小于64字节的帧都是无效帧（冲突帧）**，直接丢弃
- **老师强调**：10 Mbit/s 以太网的经典数值：争用期 51.2μs，最短帧长 **64字节 (512 bit)**

#### 计算公式 ⭐ **核心公式**
$$\text{最短帧长 (bit)} = \text{数据传输速率} \times \text{争用期} (2\tau)$$
$$2\tau = 2 \times \frac{\text{距离}}{\text{信号传播速度}}$$

#### 典型计算题 ⭐ **必考题型**
1. **已知网络传输速率、线缆长度、信号传播速度，求最短有效帧长**
   - 步骤：
     1. 计算单程传播时延：$\tau = \frac{\text{距离}}{\text{信号传播速度}}$
     2. 计算争用期：$2\tau$
     3. 计算最短帧长：$\text{最短帧长} = \text{速率} \times 2\tau$

2. **已知最短帧长、速率，求最大传输距离**
   - 步骤：
     1. 从最短帧长计算争用期：$2\tau = \frac{\text{最短帧长}}{\text{速率}}$
     2. 计算单程传播时延：$\tau = \frac{2\tau}{2}$
     3. 计算最大距离：$\text{距离} = \tau \times \text{信号传播速度}$

#### 解题技巧
- **注意单位换算**：
  - 距离：km ↔ m（1 km = 1000 m）
  - 数据量：bit ↔ Byte（1 Byte = 8 bit）
  - 时间：s ↔ μs（1 s = $10^6$ μs）
  - 速率：Mbit/s = $10^6$ bit/s

## 截断二进制指数退避算法 ⭐ **必考**

### 算法步骤
1. 确定基本退避时间：$2\tau$（$\tau$ 为端到端的传播时延，$2\tau$为争用期）
2. 计算参数 $k$：$k = \min\{\text{重传次数}, 10\}$
3. 从整数集合 $\{0, 1, ..., 2^k - 1\}$ 中随机选择一个数 $r$
4. 计算退避时间：$\text{退避时间} = r \times 2\tau$

### 特点
- **重传次数越多，退避时间越长**：$k$值增大，可选范围增大
- **最大退避时间限制**：$2^{10} \times 2\tau = 1024 \times 2\tau$（当$k=10$时达到上限）
- **重传上限**：重传**16次**后仍不成功，则丢弃该帧，并向高层报告

### 详细示例

#### 第1次碰撞（重传次数=1）
- $k = \min\{1, 10\} = 1$
- 可选集合：$\{0, 1\}$（共2个数）
- 退避时间：$0 \times 2\tau = 0$ 或 $1 \times 2\tau = 2\tau$

#### 第2次碰撞（重传次数=2）
- $k = \min\{2, 10\} = 2$
- 可选集合：$\{0, 1, 2, 3\}$（共4个数）
- 退避时间：$0, 2\tau, 4\tau, 6\tau$

#### 第3次碰撞（重传次数=3）
- $k = \min\{3, 10\} = 3$
- 可选集合：$\{0, 1, 2, 3, 4, 5, 6, 7\}$（共8个数）
- 退避时间：$0, 2\tau, 4\tau, 6\tau, 8\tau, 10\tau, 12\tau, 14\tau$

#### 第10次碰撞（重传次数=10）
- $k = \min\{10, 10\} = 10$
- 可选集合：$\{0, 1, 2, ..., 1023\}$（共1024个数）
- 退避时间：$0, 2\tau, 4\tau, ..., 2046\tau$

#### 第11次及以后碰撞（重传次数≥11）
- $k = \min\{11, 10\} = 10$（被截断到10）
- 可选集合：$\{0, 1, 2, ..., 1023\}$（保持1024个数）
- 退避时间：$0, 2\tau, 4\tau, ..., 2046\tau$（不再增大）

### 常考点 ⭐ **必考**
- **第1、2、3次碰撞后的$r$取值范围**：$\{0,1\}$、$\{0,1,2,3\}$、$\{0,1,...,7\}$
- **何时达到上限**：第10次碰撞时达到上限，$k=10$，可选1024个数
- **重传失败次数**：16次后丢弃帧

## CSMA/CD协议的工作流程

1. **准备发送**：适配器从网络层获得一个分组，加上以太网的首部和尾部，组成以太网帧
2. **检测信道**：若检测到信道忙，则继续检测，直到信道空闲
3. **发送数据**：若检测到信道空闲，在96比特时间内信道保持空闲，就发送这个帧
4. **边发送边监听**：在发送过程中继续检测信道
5. **碰撞处理**：
   - 若检测到碰撞，立即停止发送数据，并发送人为干扰信号
   - 执行截断二进制指数退避算法，等待一段随机时间后重新发送
6. **返回步骤2**：若重传16次仍不成功，则停止重传并向上层报告

