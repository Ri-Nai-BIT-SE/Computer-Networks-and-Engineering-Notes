# 3.5.3 轮流协议 (Taking-Turns Protocols)

这类协议试图结合信道划分和随机访问两者的优点：在高负载时像信道划分一样高效无冲突，在低负载时像随机访问一样让单个节点独享全部带宽。

### 核心概念

#### 1. 轮询 (Polling)

轮询协议采用**集中式控制**的方式来协调多个节点对共享信道的访问。

##### 基本原理

*   **网络结构**: 
    *   网络中有一个**主节点 (Master Node)**。
    *   多个**从节点 (Slave Nodes)**。

*   **工作流程**:
    1.  主节点按照某种**预定的顺序**（通常是轮流）依次"邀请"每个从节点。
    2.  被邀请的从节点可以发送数据（如果有的话）。
    3.  **只有被邀请的从节点才能发送**，其他节点必须等待。
    4.  一个从节点发送完毕后（或者没有数据要发），主节点继续邀请下一个从节点。

**示意图**：
```
主节点 Master
    |
    |-- 轮询 → 从节点A（发送数据）
    |-- 轮询 → 从节点B（无数据）
    |-- 轮询 → 从节点C（发送数据）
    |-- 轮询 → 从节点D（发送数据）
    └-- 循环...
```

##### 优点

*   **无冲突**: 
    *   由于在任何时刻只有一个节点被允许发送。
    *   完全避免了冲突。

*   **公平性**: 
    *   每个从节点都会被轮流邀请。
    *   保证了公平的信道访问机会。

*   **高负载时效率高**: 
    *   当所有节点都有数据要发送时。
    *   信道可以被充分利用。

##### 缺点

*   **轮询开销**: 
    *   主节点发送轮询消息本身需要时间。
    *   这部分时间无法用于数据传输。
    *   轮询开销 = 轮询帧的发送时间 + 传播时延。

*   **时延**: 
    *   即使某个从节点有紧急数据要发送。
    *   也必须等待主节点轮询到它。
    *   最坏情况下的等待时间 = (N-1) × 轮询周期（N 为节点总数）。

*   **单点故障**: 
    *   如果**主节点崩溃**，整个网络将**瘫痪**。
    *   这是最严重的缺点。

*   **可扩展性差**: 
    *   节点数量增加时，轮询周期变长。
    *   时延和开销都会增大。

##### 应用场景

*   **蓝牙 (Bluetooth)**: 
    *   主设备（如手机）轮询从设备（如耳机、键盘）。

*   **集中式网络**: 
    *   早期的终端-主机系统。

#### 2. 令牌传递 (Token Passing)

令牌传递协议采用**分布式控制**的方式，通过一个特殊的控制帧来协调信道访问。

##### 基本原理

*   **令牌 (Token)**: 
    *   一个特殊的、较短的控制帧（通常只有几个字节）。
    *   在所有节点之间以**预定的顺序**循环传递。

*   **传递顺序**: 
    *   通常形成一个**逻辑环 (Logical Ring)**。
    *   即使物理拓扑不是环形，逻辑上也按环形顺序传递令牌。

**示意图**：
```
物理总线拓扑:
┌────┬────┬────┬────┐
│ A  │ B  │ C  │ D  │
└────┴────┴────┴────┘

逻辑环:
   A → B → C → D → A
   ↑               ↓
   └───────────────┘
```

##### 工作流程

1.  令牌在网络中按照预定顺序循环传递。

2.  **节点有数据要发**:
    *   当节点收到令牌时，"捕获"令牌（不再传递）。
    *   发送一帧或多帧数据（通常有时间限制，如最多占用令牌 $T$ 秒）。
    *   数据发送完毕后，**释放令牌**，传给下一个节点。

3.  **节点无数据要发**:
    *   收到令牌后，立即将其传给下一个节点。
    *   不占用信道时间。

##### 令牌帧格式

令牌通常包含以下信息：
*   **帧类型**: 标识这是一个令牌帧。
*   **状态位**: 指示令牌是空闲还是忙碌。
*   **优先级**: 某些协议支持优先级机制。

##### 优点

*   **无冲突**: 
    *   只有持有令牌的节点才能发送。
    *   完全避免了冲突。

*   **公平性**: 
    *   每个节点都有机会获得令牌。
    *   保证了公平的信道访问。

*   **分布式控制**: 
    *   不依赖于单个主节点。
    *   在设计上比轮询更加健壮。

*   **高负载时效率高**: 
    *   当所有节点都有数据时。
    *   信道利用率接近 100%。

*   **低负载时也高效**: 
    *   如果只有一个节点活跃。
    *   令牌会快速回到该节点。
    *   该节点可以频繁发送数据。

##### 缺点

*   **令牌开销**: 
    *   令牌传递本身消耗带宽。
    *   即使没有数据传输，令牌也要在网络中循环。

*   **时延**: 
    *   节点必须等待令牌到达才能发送。
    *   最坏情况等待时间 = 令牌环的一周时间。

*   **单点故障（令牌层面）**: 
    *   **令牌丢失**: 
        *   如果令牌在传输中丢失，整个网络将无法工作。
        *   需要令牌恢复机制（如超时后重新生成令牌）。
    *   **令牌重复**: 
        *   如果网络中出现多个令牌，会导致冲突。
        *   需要令牌去重机制。
    *   **节点故障**: 
        *   如果某个节点崩溃且持有令牌，令牌无法继续传递。
        *   需要绕过故障节点的机制。

*   **实现复杂**: 
    *   需要复杂的令牌管理和错误恢复机制。
    *   包括：令牌丢失检测、令牌重生成、节点加入/退出环等。

##### 应用

*   **令牌环网 (Token Ring, IEEE 802.5)**: 
    *   曾经是重要的局域网技术。
    *   在 1980-1990 年代与以太网竞争。
    *   现已基本被以太网取代。

*   **FDDI (Fiber Distributed Data Interface)**: 
    *   光纤分布式数据接口。
    *   使用双环令牌传递。
    *   提供高可靠性和高速率（100 Mbps）。

### 轮流协议的总体评价

#### 优点

*   **无冲突**: 两种协议都从根本上避免了冲突。

*   **兼顾高负载和低负载**:
    *   高负载时：信道利用率高，接近 100%。
    *   低负载时：活跃节点可以快速访问信道。

*   **公平性**: 保证每个节点都有访问信道的机会。

#### 缺点

*   **开销**: 轮询或令牌传递本身的开销。

*   **时延**: 必须等待轮询或等待令牌。

*   **复杂性**: 
    *   需要复杂的管理和错误恢复机制。
    *   实现难度高于随机访问协议。

*   **单点故障**: 
    *   轮询协议：主节点故障。
    *   令牌传递：令牌丢失或节点故障。

### 三类 MAC 协议对比

| 特性 | 信道划分 | 随机访问 | 轮流协议 |
|:---|:---|:---|:---|
| **代表协议** | FDM, TDM, CDMA | ALOHA, CSMA/CD | 轮询, 令牌传递 |
| **冲突** | 无冲突 | 有冲突 | 无冲突 |
| **公平性** | 完全公平 | 不保证公平 | 保证公平 |
| **高负载效率** | 高 | 低（冲突多） | 高 |
| **低负载效率** | 低（资源浪费） | 高 | 中（有开销） |
| **时延** | 固定 | 可变（冲突时大） | 可变（轮询/令牌周期） |
| **实现复杂度** | 简单 | 中等 | 复杂 |
| **可扩展性** | 差（用户数固定） | 好 | 中（轮询差，令牌中等） |
| **单点故障** | 无 | 无 | 有（主节点/令牌） |
| **典型应用** | 3G通信, 光纤WDM | 以太网 | 令牌环网, 蓝牙 |

### 易考点 & 难点

*   **易考点**:
    *   轮询和令牌传递的基本工作原理。
    *   理解这两种协议如何做到"无冲突"。
    *   轮询和令牌传递的优缺点对比。
    *   三类 MAC 协议（信道划分、随机访问、轮流）的特点对比。

*   **难点**:
    *   **轮流协议的性能分析**: 
        *   分析轮询延迟和令牌传递时间。
        *   理解开销对信道利用率的影响。
    
    *   **单点故障问题**: 
        *   理解轮询协议中主节点故障的影响。
        *   理解令牌传递协议中令牌丢失、节点故障的影响。
        *   了解相应的恢复机制。
    
    *   **协议选择**: 
        *   能够根据网络特点（负载、节点数、实时性要求等）。
        *   选择合适的 MAC 协议。
        *   这是综合性的分析题。
